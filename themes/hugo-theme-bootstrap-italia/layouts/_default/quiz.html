{{ define "main" }}
<iframe name="hidden_iframe" id="hidden_iframe" class="hidden"></iframe>

<div class="container">
  <div class="row">
    <div class="col col-lg-8 my-5">
      <h2>{{ .Page.Params.quiztitle }}</h2>
      <div class="callout callout-highlight"><p>{{ .Page.Params.description }}</p></div>

      <div class="notification with-icon error" style="z-index: 1000" role="alert" aria-labelledby="missing-title" id="missing">
        <h5 id="missing-title"><svg class="icon"><use xlink:href="{{ $.Site.BaseURL }}svg/sprite.svg#it-close-circle"></use></svg>{{ T "answer-needed" }}</h5>
      </div>

      <form id="quiz">
        {{ $divnum := 0 }}
        {{ $elems := len .Page.Params.questions }}

        {{ range .Page.Params.questions }}
          {{ $progress := div (mul 100 $divnum) $elems }}
          {{ $divnum = add $divnum 1 }}

          <div class="question {{ if ne $divnum 1 }}hidden{{ end }}" id="div_{{ $divnum }}">
            {{ $curquestion := . }}
            <p class="title_question">{{ .text }}</p>
                    
            <div>
              {{ range .choices }}
                {{ if eq $curquestion.type "radiogroup" }}
                  <div class="form-check valign">
                      <input name="{{ $curquestion.name }}" id="{{ $curquestion.name }}_{{ .value }}" type="radio" value="{{ .value }}" required />
                      <label class="label_check" for="{{ $curquestion.name }}_{{ .value }}" class="form-text">{{ .text }}</label>
                  </div>
                {{ end }}

                {{ if eq $curquestion.type "checkbox" }}
                  <div class="form-check valign">
                      <input name="{{ $curquestion.name }}" id="{{ $curquestion.name }}_{{ .value }}" type="checkbox" value="{{ .value }}" />
                      <label class="label_check" for="{{ $curquestion.name }}_{{ .value }}" class="form-text">{{ .text }}</label>
                  </div>
                {{ end }}
              {{ end}}
            </div>

            <p>&nbsp;</p>

            <div class="progress-bar-wrapper">
              <div class="progress-bar-label"><span class="sr-only">Progresso </span>{{ $progress }}%</div>
              <div class="progress">
                <div class="progress-bar" role="progressbar" style="width: {{ $progress }}%" aria-valuenow="{{ $progress }}" aria-valuemin="0" aria-valuemax="100"></div>
              </div>
            </div>

            <p>&nbsp;</p>

            {{ if ne $divnum $elems }}
            <div class="mx-auto text-center">
              <input type="button" class="btn btn-primary" value="{{ T "next-question" }}" onclick="nextQuestion({{ $divnum }})">
            </div>
            {{ end }}

            {{ if eq $divnum $elems }}
            <div class="mx-auto text-center">
              <input type="submit" class="btn btn-primary" value="{{ T "send-quiz" }}">
            </div>
            {{ end }}
          </div>
        {{ end }}

        <input type="hidden" id="quiztype" name="quiztype" value="{{ .Page.Params.type }}">
      </form>

      <div id="result"></div>
    </div>
  </div>
</div>

<script type="text/javascript">
  $('head').append('<link rel="stylesheet" href="{{ $.Site.BaseURL }}css/quiz.css" type="text/css" />');

  function nextQuestion(itemid) {
    if ($("input[name='question1']").filter(':checked').val() === undefined) {
      notificationShow('missing', 6000);
      return;
    }
    
    $("#div_"+itemid).addClass("hidden");
    $("#div_"+(itemid+1)).removeClass("hidden");
  }

  jQuery(document).ready(function($) {
    var request;
    
    $("#quiz").submit(function(event) {
      $("#div_{{ $elems }}").addClass("hidden");

      if (request) request.abort();
      
      var $form = $(this);
      var $inputs = $form.find("input, select, button, textarea");
      var serializedData = $form.serialize();
    
      $inputs.prop("disabled", true);
      $('#result').text('Sending data...');
    
      request = $.ajax({
        url: "https://script.google.com/a/teamdigitale.governo.it/macros/s/AKfycbwIWmC3tpgZSwBK_nK6JwmkVH2u23t0VLJkr4zszQ/exec",
        type: "post",
        data: serializedData,
        target: '#hidden_iframe'
      });
    
      request.done(function (response){
        if (response.result == "error") {
          $('#result').html('Si Ã¨ verificato un errore.');
        }
        else {
          $('#result').html('<a href="https://docs.google.com/spreadsheets/d/1Yiz5JL7N36SQFbhpnuicSeS259mRfTzHy4XR4VKUvRc/edit#gid=0" target="_blank">Success - see Google Sheet</a>');
        }
      });
    
      request.fail(function (jqXHR, textStatus, errorThrown){
        console.error("The following error occured: " + textStatus, errorThrown);
      });
    
      request.always(function () {
        $inputs.prop("disabled", false);
      });
    
      event.preventDefault();
    });
  });
</script>
{{ end }}